<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Syst√®me Professionnel de Gestion de T√¢ches</title>
<style>
/* CSS GLOBAL */
body {margin:0;font-family:"Roboto","Segoe UI",Arial;background:#f4f7f6;display:flex;min-height:100vh;}
.sidebar {width:260px;background:#1a4d8c;color:white;padding:20px 15px;position:fixed;left:0;top:0;height:100%;box-shadow:0 4px 8px rgba(0,0,0,0.3);box-sizing:border-box;}
.sidebar h2{text-align:center;margin:0 0 20px;font-size:22px;color:#f0f2f5;}
.menu-item{padding:12px 18px;cursor:pointer;transition:background 0.2s,border-left 0.2s;border-left:4px solid transparent;border-radius:6px;margin-bottom:4px;}
.menu-item:hover,.menu-item.active{background:#255d9c;border-left-color:#ffcc00;}
.sidebar-stats{margin-top:15px;font-size:14px;background:rgba(0,0,0,0.15);border-radius:8px;padding:10px;}
.sidebar-stats p{margin:4px 0;}
.content{margin-left:280px;padding:30px;width:calc(100% - 280px);max-width:100%;box-sizing:border-box;}
.card{background:white;padding:25px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.1);margin-bottom:30px;transition:transform 0.3s;}
.card h3{margin-top:0;}
input,select,button{padding:10px;width:100%;margin-top:8px;border-radius:8px;border:1px solid #dcdcdc;font-size:15px;box-sizing:border-box;}
button{background:#1a4d8c;color:white;cursor:pointer;font-weight:600;transition:background 0.2s,transform 0.05s;border:none;}
button:hover{background:#0f386b;transform:translateY(-1px);}
button:disabled{opacity:0.6;cursor:default;transform:none;}

.task{padding:16px 16px 12px;margin:14px 0;border-radius:10px;border-left:8px solid #3498db;background:#ffffff;box-shadow:0 1px 3px rgba(0,0,0,0.08);transition:all 0.2s;}
.task-title-row{display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:4px;}
.task-title{font-size:17px;font-weight:bold;color:#333;margin:0;}
.task-priority{font-size:11px;font-weight:600;padding:3px 8px;border-radius:999px;text-transform:uppercase;letter-spacing:0.03em;}
.priority-low{background:#e8f5e9;color:#2e7d32;}
.priority-normal{background:#e3f2fd;color:#1565c0;}
.priority-high{background:#ffebee;color:#c62828;}
.task-info{font-size:13px;color:#777;margin-bottom:8px;}
.done{border-left-color:#27ae60 !important;background:#e9f7ef;}
.late{border-left-color:#e74c3c !important;background:#fcecec;}
.encours{border-left-color:#f1c40f !important;background:#fff8e1;}
.task-buttons{display:flex;flex-wrap:wrap;gap:8px;margin-top:4px;}
.task-buttons button{width:auto;padding:6px 12px;font-size:13px;margin-top:0;}

.modal-bg{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);justify-content:center;align-items:center;z-index:2000;}
.modal{background:white;padding:30px;width:420px;max-width:90%;border-radius:12px;text-align:center;border-top:8px solid #e74c3c;animation:fadeIn 0.25s ease-out;}
.modal h3{font-size:22px;color:#e74c3c;margin-bottom:10px;}
.modal button{margin-top:20px;width:180px;background:#e74c3c;}
@keyframes fadeIn {from{opacity:0;transform:scale(0.9);}to{opacity:1;transform:scale(1);}}
.text-danger{color:#e74c3c;}
.text-success{color:#27ae60;}

/* TOASTS */
.toast-container{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);z-index:3000;display:flex;flex-direction:column;gap:8px;align-items:center;}
.toast{min-width:260px;max-width:420px;background:#323232;color:white;padding:10px 14px;border-radius:8px;font-size:14px;box-shadow:0 2px 6px rgba(0,0,0,0.25);opacity:0;transform:translateY(10px);transition:opacity 0.2s,transform 0.2s;}
.toast.show{opacity:1;transform:translateY(0);}
.toast-success{background:#2e7d32;}
.toast-error{background:#c62828;}

/* √âcran de connexion */
#loginScreen{position:fixed;inset:0;display:flex;justify-content:center;align-items:center;background:#1a4d8c;color:white;z-index:2500;}
#loginBox{background:white;color:#333;padding:30px;border-radius:12px;box-shadow:0 4px 15px rgba(0,0,0,0.3);width:320px;max-width:90%;}
#loginBox h2{text-align:center;margin-top:0;margin-bottom:15px;}

/* Responsive simple */
@media (max-width:768px){
  body{flex-direction:column;}
  .sidebar{position:relative;width:100%;height:auto;box-shadow:none;display:flex;flex-direction:column;align-items:stretch;}
  .content{margin-left:0;width:100%;padding:15px;}
}
</style>
</head>

<body>

<!-- √âCRAN DE CONNEXION -->
<div id="loginScreen">
  <div id="loginBox">
    <h2>Connexion</h2>
    <label for="loginUser">Nom d'utilisateur</label>
    <input id="loginUser" type="text" placeholder="Utilisateur">
    
    <label for="loginPass" style="margin-top:12px;display:block;">Mot de passe</label>
    <input id="loginPass" type="password" placeholder="Mot de passe">

    <button id="btnLogin" style="margin-top:18px;width:100%;">Se connecter</button>
    <p id="loginError" style="color:#e74c3c;margin-top:10px;font-size:13px;display:none;">Identifiants incorrects.</p>
    <p style="margin-top:10px;font-size:12px;color:#555;">
      Utilisez un compte cr√©√© via /api/register sur l'API.
    </p>
  </div>
</div>

<!-- APPLICATION DE T√ÇCHES -->
<div class="sidebar">
  <h2>üìã GESTION PRO</h2>
  <div class="menu-item active" data-filter="all">Toutes les t√¢ches</div>
  <div class="menu-item" data-filter="encours">En cours</div>
  <div class="menu-item" data-filter="retard">En retard</div>
  <div class="menu-item" data-filter="termine">Termin√©es</div>

  <div class="sidebar-stats">
    <p><strong>Statistiques</strong></p>
    <p>En cours : <span id="statEncours">0</span></p>
    <p>En retard : <span id="statRetard">0</span></p>
    <p>Termin√©es : <span id="statTermine">0</span></p>
  </div>

  <button id="btnClearAll" style="background:#e74c3c;margin-top:18px;">‚ùå Vider Tout (local)</button>
  <button id="btnLogout" style="background:#555;margin-top:8px;">üö™ Se d√©connecter</button>
</div>

<div class="content">
  <div class="card">
    <h3>‚ûï Ajouter une T√¢che</h3>
    <label for="desc">Description de la t√¢che</label>
    <input id="desc" placeholder="Description de la t√¢che (Max 100 caract√®res)" maxlength="100">
    
    <label for="priority">Priorit√©</label>
    <select id="priority">
      <option value="normal">Normale</option>
      <option value="high">Haute</option>
      <option value="low">Basse</option>
    </select>

    <label for="deadline">Date et heure limite</label>
    <input id="deadline" type="datetime-local">

    <button id="btnAdd">Ajouter la T√¢che</button>

    <label for="search" style="margin-top:16px;display:block;">Rechercher</label>
    <input id="search" placeholder="üîç Rechercher par nom ou description">
  </div>

  <div class="card">
    <h3>üìù Liste des T√¢ches Filtr√©es</h3>
    <div id="liste"></div>
  </div>
</div>

<div id="modalBg" class="modal-bg" role="dialog" aria-modal="true" aria-labelledby="modalTitle" aria-describedby="modalMessage">
  <div class="modal">
    <h3 id="modalTitle"></h3>
    <p id="modalMessage"></p>
    <button id="modalOk">Compris / OK</button>
  </div>
</div>

<div id="toastContainer" class="toast-container"></div>

<audio id="bip" src="https://www.soundjay.com/button/beep-07.wav" preload="auto"></audio>

<script>
(function(){
  const API_URL = "https://927f130a-0193-410c-8b50-5374ff8cf07b-00-1hp4203outhhd.spock.replit.dev";

  /* ===== Toast util ===== */
  const Toast = {
    container: null,
    init(){
      this.container = document.getElementById("toastContainer");
    },
    show(message, type="success"){
      if (!this.container) return;
      const div = document.createElement("div");
      div.className = "toast " + (type === "error" ? "toast-error" : "toast-success");
      div.textContent = message;
      this.container.appendChild(div);
      requestAnimationFrame(() => div.classList.add("show"));
      setTimeout(() => {
        div.classList.remove("show");
        setTimeout(() => div.remove(), 200);
      }, 2600);
    }
  };

  /* ===== SERVICES & STORE ===== */
  const ApiService = {
    async login(username, password){
      const resp = await fetch(API_URL + "/api/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username, password })
      });
      if (!resp.ok) throw new Error("bad_credentials");
      return resp.json();
    },
    async getTasks(token){
      const resp = await fetch(API_URL + "/api/tasks", {
        headers: { "Authorization": "Bearer " + token }
      });
      if (!resp.ok) throw new Error("api_error");
      return resp.json();
    },
    async addTask(token, payload){
      const resp = await fetch(API_URL + "/api/tasks", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": "Bearer " + token
        },
        body: JSON.stringify(payload)
      });
      if (!resp.ok) throw new Error("api_error");
      return resp.json();
    },
    async markDone(token, id){
      const resp = await fetch(`${API_URL}/api/tasks/${id}/done`, {
        method: "POST",
        headers: { "Authorization": "Bearer " + token }
      });
      if (!resp.ok) throw new Error("api_error");
    },
    async removeTask(token, id){
      const resp = await fetch(`${API_URL}/api/tasks/${id}`, {
        method: "DELETE",
        headers: { "Authorization": "Bearer " + token }
      });
      if (!resp.ok) throw new Error("api_error");
    }
  };

  const TaskStore = {
    tasks: [],
    loadFromLocal(){
      this.tasks = JSON.parse(localStorage.getItem("taches") || "[]");
      this.tasks.forEach(t => {
        if (typeof t.notificationEnvoyee === "undefined") t.notificationEnvoyee = false;
        if (!t.priority) t.priority = "normal";
      });
    },
    saveToLocal(){
      localStorage.setItem("taches", JSON.stringify(this.tasks));
    }
  };

  /* ===== UI / HELPERS ===== */
  const UI = {
    elements: {},
    audio: null,
    sonAutorise: false,
    modalOuvert: false,
    bipInterval: null,
    titleDefault: document.title,
    titleAlert: "üö® RETARD CRITIQUE üö®",
    titleInterval: null,
    currentModalType: "danger",

    initDom(){
      this.elements.loginScreen = document.getElementById("loginScreen");
      this.elements.loginUser = document.getElementById("loginUser");
      this.elements.loginPass = document.getElementById("loginPass");
      this.elements.loginBtn = document.getElementById("btnLogin");
      this.elements.loginError = document.getElementById("loginError");

      this.elements.desc = document.getElementById("desc");
      this.elements.priority = document.getElementById("priority");
      this.elements.deadline = document.getElementById("deadline");
      this.elements.search = document.getElementById("search");
      this.elements.liste = document.getElementById("liste");
      this.elements.modalBg = document.getElementById("modalBg");
      this.elements.modalTitle = document.getElementById("modalTitle");
      this.elements.modalMessage = document.getElementById("modalMessage");
      this.elements.modalOk = document.getElementById("modalOk");
      this.elements.menuItems = document.querySelectorAll(".menu-item");
      this.elements.btnAdd = document.getElementById("btnAdd");
      this.elements.btnClearAll = document.getElementById("btnClearAll");
      this.elements.btnLogout = document.getElementById("btnLogout");
      this.elements.statEncours = document.getElementById("statEncours");
      this.elements.statRetard = document.getElementById("statRetard");
      this.elements.statTermine = document.getElementById("statTermine");

      this.audio = document.getElementById("bip");
    },

    parseLocalDateTime(str){
      if (!str) return null;
      const [datePart, timePart] = str.split("T");
      if (!datePart || !timePart) return null;
      const [y,m,d] = datePart.split("-").map(Number);
      const [hh,mm] = timePart.split(":").map(Number);
      return new Date(y, m-1, d, hh, mm, 0, 0);
    },

    formatTime(dateStr){
      const d = this.parseLocalDateTime(dateStr) || new Date(dateStr);
      if (isNaN(d.getTime())) return "Date invalide";
      return d.toLocaleString("fr-FR", {
        year:"numeric",month:"short",day:"numeric",
        hour:"2-digit",minute:"2-digit"
      });
    },

    getTimeDifference(deadline){
      const now = new Date();
      const d = this.parseLocalDateTime(deadline);
      if (!d || isNaN(d.getTime())) return "Date invalide";
      const diff = d.getTime() - now.getTime();
      const abs = Math.abs(diff);
      if (abs < 60000) return "Moins d'une minute";
      const minutes = Math.floor(abs / 60000);
      const hours = Math.floor(abs / 3600000);
      const days = Math.floor(abs / 86400000);
      if (diff > 0){
        if (days>0) return `Dans ${days} jour${days>1?"s":""}`;
        if (hours>0) return `Dans ${hours} heure${hours>1?"s":""}`;
        return `Dans ${minutes} minute${minutes>1?"s":""}`;
      } else {
        if (days>0) return `Il y a ${days} jour${days>1?"s":""} de retard`;
        if (hours>0) return `Il y a ${hours} heure${hours>1?"s":""} de retard`;
        return `Il y a ${minutes} minute${minutes>1?"s":""} de retard`;
      }
    },

    escapeHtml(str){
      const div = document.createElement("div");
      div.textContent = str;
      return div.innerHTML;
    },

    demarrerAudio(){
      if (this.sonAutorise || !this.audio) return;
      const playPromise = this.audio.play();
      if (playPromise){
        playPromise.then(() => {
          this.audio.pause();
          this.audio.currentTime = 0;
          this.sonAutorise = true;
        }).catch(() => {});
      }
    },

    jouerBip(){
      if (!this.audio) return;
      if (this.sonAutorise){
        this.audio.currentTime = 0;
        this.audio.play().catch(() => {});
      } else {
        this.demarrerAudio();
      }
    },

    startBip(){
      if (this.bipInterval) return;
      this.bipInterval = setInterval(() => this.jouerBip(), 1500);
    },

    stopBip(){
      if (this.bipInterval){
        clearInterval(this.bipInterval);
        this.bipInterval = null;
      }
    },

    clearTitleAlert(){
      if (this.titleInterval){
        clearInterval(this.titleInterval);
        this.titleInterval = null;
        document.title = this.titleDefault;
      }
    },

    ouvrirModal(title, msgHtml, type="danger"){
      if (document.visibilityState !== "visible" && type === "danger") return;
      if (this.modalOuvert && type === "danger") return;
      this.currentModalType = type;
      this.elements.modalTitle.textContent = title;
      this.elements.modalTitle.className = type === "danger" ? "text-danger" : "text-success";
      this.elements.modalMessage.innerHTML = msgHtml;
      this.elements.modalBg.style.display = "flex";
      this.modalOuvert = true;
      if (type==="danger") this.startBip(); else this.stopBip();
    },

    fermerModal(){
      this.elements.modalBg.style.display = "none";
      this.modalOuvert = false;
    },

    updateStats(tasks){
      const enc = tasks.filter(t => t.statut==="En cours").length;
      const ret = tasks.filter(t => t.statut==="En retard").length;
      const fin = tasks.filter(t => t.statut==="Termin√©").length;
      this.elements.statEncours.textContent = enc;
      this.elements.statRetard.textContent = ret;
      this.elements.statTermine.textContent = fin;
    },

    renderTasks(tasks, filter, search){
      const now = new Date();
      tasks.forEach(t => {
        const d = this.parseLocalDateTime(t.deadline);
        if (t.statut !== "Termin√©" && d && !isNaN(d.getTime())){
          t.statut = d < now ? "En retard" : "En cours";
        }
      });

      const list = this.elements.liste;
      list.innerHTML = "";
      const q = search.trim().toLowerCase();

      const filtered = tasks.filter(t => {
        if (filter==="encours" && t.statut!=="En cours") return false;
        if (filter==="retard" && t.statut!=="En retard") return false;
        if (filter==="termine" && t.statut!=="Termin√©") return false;
        if (q && !t.desc.toLowerCase().includes(q)) return false;
        return true;
      });

      if (!filtered.length){
        const p = document.createElement("p");
        p.style.padding = "20px";
        p.style.textAlign = "center";
        p.style.color = "#555";
        p.innerHTML = `Aucune t√¢che trouv√©e dans le filtre <strong>${this.escapeHtml(filter)}</strong>.`;
        list.appendChild(p);
        return;
      }

      filtered.forEach(t => {
        const css = t.statut==="Termin√©" ? "done" : t.statut==="En retard" ? "late" : "encours";
        const titreCouleur = t.statut==="En retard" ? "text-danger" : t.statut==="Termin√©" ? "text-success" : "";

        const taskDiv = document.createElement("div");
        taskDiv.className = `task ${css}`;

        const titleRow = document.createElement("div");
        titleRow.className = "task-title-row";

        const titleDiv = document.createElement("h4");
        titleDiv.className = `task-title ${titreCouleur}`;
        titleDiv.textContent = t.desc;

        const pr = document.createElement("span");
        pr.className = "task-priority " + (
          t.priority==="high" ? "priority-high" :
          t.priority==="low" ? "priority-low" : "priority-normal"
        );
        pr.textContent = t.priority==="high" ? "Haute" : t.priority==="low" ? "Basse" : "Normale";

        titleRow.appendChild(titleDiv);
        titleRow.appendChild(pr);

        const infoDiv = document.createElement("div");
        infoDiv.className = "task-info";
        const timeText = this.formatTime(t.deadline);
        const diffText = this.getTimeDifference(t.deadline);
        infoDiv.innerHTML = `
          √âch√©ance: ${this.escapeHtml(timeText)}<br>
          Statut : <strong>${this.escapeHtml(t.statut)}</strong> (${this.escapeHtml(diffText)})
        `;

        const buttonsDiv = document.createElement("div");
        buttonsDiv.className = "task-buttons";

        if (t.statut !== "Termin√©"){
          const btnTerminer = document.createElement("button");
          btnTerminer.textContent = "‚úî Terminer";
          btnTerminer.addEventListener("click", () => App.handleMarkDone(t.id));
          buttonsDiv.appendChild(btnTerminer);
        }

        const btnSupprimer = document.createElement("button");
        btnSupprimer.textContent = "üóë Supprimer";
        btnSupprimer.style.background = "#e74c3c";
        btnSupprimer.addEventListener("click", () => App.handleDelete(t.id));
        buttonsDiv.appendChild(btnSupprimer);

        taskDiv.appendChild(titleRow);
        taskDiv.appendChild(infoDiv);
        taskDiv.appendChild(buttonsDiv);
        list.appendChild(taskDiv);
      });
    }
  };

  /* ===== APP ===== */
  const App = {
    isAuthenticated:false,
    authToken:null,
    currentFilter:"all",

    init(){
      Toast.init();
      UI.initDom();
      TaskStore.loadFromLocal();

      const savedToken = localStorage.getItem("authToken");
      if (savedToken){
        this.authToken = savedToken;
        this.isAuthenticated = true;
        UI.elements.loginScreen.style.display = "none";
        this.syncFromServer();
      }

      this.bindEvents();
      if (this.isAuthenticated){
        this.refreshView();
      }
    },

    bindEvents(){
      UI.elements.loginBtn.addEventListener("click", () => this.login());
      UI.elements.loginPass.addEventListener("keydown", e => { if (e.key==="Enter") this.login(); });

      UI.elements.menuItems.forEach(item => {
        item.addEventListener("click", () => {
          const type = item.getAttribute("data-filter");
          this.currentFilter = type;
          UI.elements.menuItems.forEach(el => el.classList.remove("active"));
          item.classList.add("active");
          this.refreshView();
        });
      });

      UI.elements.btnAdd.addEventListener("click", () => this.handleAddTask());
      UI.elements.btnClearAll.addEventListener("click", () => this.clearLocal());
      UI.elements.btnLogout.addEventListener("click", () => this.logout());
      UI.elements.search.addEventListener("input", () => this.refreshView());
      UI.elements.modalOk.addEventListener("click", () => UI.fermerModal());

      document.addEventListener("visibilitychange", () => {
        if (document.visibilityState === "visible") UI.clearTitleAlert();
      });
    },

    async login(){
      const u = UI.elements.loginUser.value.trim();
      const p = UI.elements.loginPass.value;
      if (!u || !p){
        UI.elements.loginError.textContent = "Veuillez saisir utilisateur et mot de passe.";
        UI.elements.loginError.style.display = "block";
        return;
      }
      UI.elements.loginBtn.disabled = true;
      try {
        const data = await ApiService.login(u,p);
        this.authToken = data.token;
        localStorage.setItem("authToken", this.authToken);
        this.isAuthenticated = true;
        UI.elements.loginScreen.style.display = "none";
        UI.elements.loginError.style.display = "none";
        await this.syncFromServer();
        UI.demarrerAudio();
        setInterval(() => this.refreshView(), 5000);
        setInterval(() => this.checkAlerts(), 60000);
        this.refreshView();
        Toast.show("Connexion r√©ussie.");
      } catch (e){
        UI.elements.loginError.textContent = "Identifiants incorrects ou erreur serveur.";
        UI.elements.loginError.style.display = "block";
      } finally {
        UI.elements.loginBtn.disabled = false;
      }
    },

    async syncFromServer(){
      if (!this.authToken) return;
      try{
        const data = await ApiService.getTasks(this.authToken);
        TaskStore.tasks = data.map(t => ({ ...t, priority: t.priority || "normal", notificationEnvoyee: t.notificationEnvoyee || false }));
        TaskStore.saveToLocal();
      } catch(e){
        Toast.show("Impossible de charger les t√¢ches depuis le serveur.", "error");
      }
    },

    async handleAddTask(){
      if (!this.isAuthenticated) return;
      const desc = UI.elements.desc.value.trim();
      const deadline = UI.elements.deadline.value;
      const priority = UI.elements.priority.value || "normal";
      if (!desc || !deadline){
        UI.ouvrirModal("Champs manquants","Veuillez remplir la description, la priorit√© et la date limite.","danger");
        return;
      }
      const d = UI.parseLocalDateTime(deadline);
      if (!d || isNaN(d.getTime())){
        UI.ouvrirModal("Date invalide","Veuillez saisir une date valide.","danger");
        return;
      }
      if (!this.authToken){
        UI.ouvrirModal("Non connect√©","Veuillez vous reconnecter.","danger");
        return;
      }
      UI.elements.btnAdd.disabled = true;
      try{
        const newTask = await ApiService.addTask(this.authToken, { desc, deadline, priority });
        TaskStore.tasks.push({ ...newTask, priority: newTask.priority || priority, notificationEnvoyee:false });
        TaskStore.saveToLocal();
        this.refreshView();
        Toast.show("T√¢che ajout√©e avec succ√®s.");
        UI.elements.desc.value = "";
      } catch(e){
        Toast.show("Erreur lors de l'ajout de la t√¢che.","error");
      } finally{
        UI.elements.btnAdd.disabled = false;
      }
    },

    async handleMarkDone(id){
      if (!this.authToken) return;
      try{
        await ApiService.markDone(this.authToken,id);
        const t = TaskStore.tasks.find(x => x.id===id);
        if (t){
          t.statut = "Termin√©";
          t.notificationEnvoyee = false;
          TaskStore.saveToLocal();
          this.refreshView();
          Toast.show("T√¢che marqu√©e comme termin√©e.");
        }
      } catch(e){
        Toast.show("Erreur lors de la mise √† jour de la t√¢che.","error");
      }
    },

    async handleDelete(id){
      if (!this.authToken) return;
      const t = TaskStore.tasks.find(x => x.id===id);
      if (!t) return;
      if (!confirm(`Supprimer la t√¢che "${t.desc}" ?`)) return;
      try{
        await ApiService.removeTask(this.authToken,id);
        TaskStore.tasks = TaskStore.tasks.filter(x => x.id!==id);
        TaskStore.saveToLocal();
        this.refreshView();
        Toast.show("T√¢che supprim√©e.");
      } catch(e){
        Toast.show("Erreur lors de la suppression.","error");
      }
    },

    clearLocal(){
      if (!confirm("Cela vide seulement le cache local (les donn√©es restent sur le serveur). Continuer ?")) return;
      localStorage.removeItem("taches");
      TaskStore.tasks = [];
      this.refreshView();
      Toast.show("Cache local vid√©.");
    },

    logout(){
      this.isAuthenticated = false;
      this.authToken = null;
      localStorage.removeItem("authToken");
      UI.elements.loginUser.value = "";
      UI.elements.loginPass.value = "";
      UI.elements.loginError.style.display = "none";
      UI.elements.loginScreen.style.display = "flex";
      UI.elements.liste.innerHTML = "";
      UI.clearTitleAlert();
      UI.stopBip();
      Toast.show("D√©connect√©.");
    },

    checkAlerts(){
      if (!this.isAuthenticated) return;
      const now = new Date();
      let urgent = false;
      TaskStore.tasks.forEach(t => {
        const d = UI.parseLocalDateTime(t.deadline);
        if (t.statut!=="Termin√©" && d && !isNaN(d.getTime())){
          if (d < now){
            t.statut = "En retard";
            urgent = true;
            if (!t.notificationEnvoyee){
              UI.ouvrirModal("‚ö†Ô∏è RETARD CRITIQUE",`RAPPEL URGENT : La t√¢che "${UI.escapeHtml(t.desc)}" est en retard !`,"danger");
              UI.jouerBip();
              t.notificationEnvoyee = true;
            }
          } else {
            t.statut = "En cours";
            t.notificationEnvoyee = false;
          }
        }
      });
      if (urgent && document.visibilityState==="hidden" && !UI.titleInterval){
        let def = true;
        UI.titleInterval = setInterval(() => {
          document.title = def ? UI.titleAlert : UI.titleDefault;
          def = !def;
        }, 1000);
      } else if (!urgent){
        UI.clearTitleAlert();
        UI.stopBip();
      }
      TaskStore.saveToLocal();
      this.refreshView();
    },

    refreshView(){
      if (!this.isAuthenticated) return;
      UI.updateStats(TaskStore.tasks);
      UI.renderTasks(TaskStore.tasks, this.currentFilter, UI.elements.search.value || "");
      TaskStore.saveToLocal();
    }
  };

  document.addEventListener("DOMContentLoaded", () => App.init());
})();
</script>
</body>
</html>
